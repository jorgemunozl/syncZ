#!/usr/bin/env python3
"""SyncZ CLI wrapper for launching the main client from a src layout."""
import os
import sys
import subprocess
from pathlib import Path

SCRIPT_DIR = Path(__file__).resolve().parent
SRC_DIR = SCRIPT_DIR / "src"
CLIENT_PATH = SRC_DIR / "syncz" / "client.py"
VENV_PYTHON = SCRIPT_DIR / ".venv" / "bin" / "python"
MODULE_ENTRYPOINT = "syncz.client"


def get_python_command():
    """Get the appropriate Python command to use."""
    if VENV_PYTHON.exists():
        return str(VENV_PYTHON)

    for candidate in ("python3", "python"):
        try:
            subprocess.run(
                [candidate, "--version"], check=True, capture_output=True
            )
            return candidate
        except (subprocess.CalledProcessError, FileNotFoundError):
            continue

    termux_python = Path("/data/data/com.termux/files/usr/bin/python")
    if termux_python.exists():
        return str(termux_python)

    print("‚ùå Error: Python not found. Please install Python 3.")
    print(f"   Tried virtual env: {VENV_PYTHON}")
    print("   Tried: python3, python")
    sys.exit(1)


def build_env():
    """Return environment with src on PYTHONPATH so imports work."""
    env = os.environ.copy()
    src_path = str(SRC_DIR)
    existing = env.get("PYTHONPATH", "")
    env["PYTHONPATH"] = (
        src_path if not existing else f"{src_path}{os.pathsep}{existing}"
    )
    return env


def main():
    """Main entry point for syncz command."""
    if not CLIENT_PATH.exists():
        print(f"‚ùå Error: client.py not found at {CLIENT_PATH}")
        print("üìÅ Contents of src directory:")
        try:
            for item in sorted(SRC_DIR.iterdir()):
                print(f"   - {item.name}")
        except Exception as e:  # pragma: no cover - defensive logging
            print(f"   Error listing src directory: {e}")
        sys.exit(1)

    python_cmd = get_python_command()
    args = [python_cmd, "-m", MODULE_ENTRYPOINT] + sys.argv[1:]
    env = build_env()

    try:
        os.chdir(SCRIPT_DIR)
        os.execvpe(python_cmd, args, env)
    except Exception as e:  # pragma: no cover - exec failure path
        print(f"‚ùå Error executing syncz: {e}")
        sys.exit(1)


if __name__ == "__main__":
    main()
