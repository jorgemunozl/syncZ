#!/usr/bin/env bash
# Unified dmenu launcher for PDFs; supports page jump via ':12', '#12', or '-P 12'.
# Usage: pdf-onebar [-x] [DIR]
#   -x / --okular   open with okular (annotation-friendly) instead of zathura
# Env:
#   PDF_DIR_DEFAULT  Default directory if no DIR arg provided (falls back to $HOME/zoteroReference/)
#   DMENU            dmenu binary (default: dmenu)
#   DMENU_ARGS       extra args for dmenu (flags only; prompt supplied here)
#   OKULAR_CMD       override okular binary (default: okular)
#   ZATHURA_CMD      override zathura binary (default: zathura)
set -euo pipefail

USE_OKULAR=0
DIR=""
ZATHURA_SECOND_PAGE=0
FLATTEN=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    -x|--okular)
      USE_OKULAR=1
      ;;
    -a|--second-page)
      ZATHURA_SECOND_PAGE=1
      ;;
    -f|--flatten)
      FLATTEN=1
      ;;
    -h|--help)
      cat <<'EOF'
Usage: pdf-onebar [-x] [DIR]
  -x, --okular   open with okular (annotation-friendly) instead of zathura
  -a, --second-page  open with zathura starting on page 2 (unless page specified)
  -f, --flatten  flatten the PDF using ghostscript before opening

Environment:
  PDF_DIR_DEFAULT  default directory if DIR is not provided
  DMENU            dmenu binary (default: dmenu)
  DMENU_ARGS       extra args for dmenu (flags only; prompt supplied here)
  OKULAR_CMD       override okular binary (default: okular)
  ZATHURA_CMD      override zathura binary (default: zathura)
EOF
      exit 0
      ;;
    *)
      DIR="$1"
      ;;
  esac
  shift
done

DIR="${DIR:-${PDF_DIR_DEFAULT:-$HOME/zoteroReference/}}"
DMENU=${DMENU:-dmenu}
DMENU_ARGS=${DMENU_ARGS:-"-i"}  # pass flags only; we'll supply the prompt
OKULAR_CMD=${OKULAR_CMD:-okular}
ZATHURA_CMD=${ZATHURA_CMD:-zathura}

# Collect PDF list (prefer fd/fdfind; fallback to find). Output relative paths.
if command -v fd >/dev/null 2>&1; then
  mapfile -t files < <(cd "$DIR" && fd -i -H -t f -e pdf .)
elif command -v fdfind >/dev/null 2>&1; then
  mapfile -t files < <(cd "$DIR" && fdfind -i -H -t f -e pdf .)
else
  mapfile -t files < <(cd "$DIR" && find . -type f -iname '*.pdf' -printf '%P\n')
fi

# Build display -> path map; show full relative paths for all files
mapfile -t lines < <(
  for f in "${files[@]:-}"; do
    [[ -n "$f" ]] || continue
    # Build absolute path robustly
    if [[ "$f" = /* ]]; then
      abs="$f"
    else
      abs="$DIR/${f#./}"
    fi
    # Clean up the relative path for display (remove leading ./)
    display_path="${f#./}"
    printf '%s\t%s\n' "$display_path" "$abs"
  done | sort -u
)

# If no items, exit gracefully
if [[ ${#lines[@]} -eq 0 ]]; then
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "No PDFs found in $DIR"
  else
    echo "No PDFs found in $DIR"
  fi
  exit 0
fi

# Present menu of display names only (dmenu prints selection or typed input)
PROMPT='pdf (append : /-P 12, -x, -f ):'
read -r -a _DMENU_ARGS <<< "$DMENU_ARGS"
choice=$(printf '%s\n' "${lines[@]}" | cut -f1 | "$DMENU" "${_DMENU_ARGS[@]}" -p "$PROMPT") || exit 0
[[ -n "$choice" ]] || exit 0

line="$choice"

# Allow typing -x/--okular inline in the prompt (prefix or suffix)
if [[ "$line" =~ ^[[:space:]]*(-x|--okular)[[:space:]]+(.*)$ ]]; then
  USE_OKULAR=1
  line="${BASH_REMATCH[2]}"
fi
if [[ "$line" =~ (.*)[[:space:]](-x|--okular)[[:space:]]*$ ]]; then
  USE_OKULAR=1
  line="${BASH_REMATCH[1]}"
fi

# Allow typing -a/--second-page inline in the prompt (prefix or suffix)
if [[ "$line" =~ ^[[:space:]]*(-a|--second-page)[[:space:]]+(.*)$ ]]; then
  ZATHURA_SECOND_PAGE=1
  line="${BASH_REMATCH[2]}"
fi
if [[ "$line" =~ (.*)[[:space:]](-a|--second-page)[[:space:]]*$ ]]; then
  ZATHURA_SECOND_PAGE=1
  line="${BASH_REMATCH[1]}"
fi

# Allow typing -f/--flatten inline in the prompt (prefix or suffix)
if [[ "$line" =~ ^[[:space:]]*(-f|--flatten)[[:space:]]+(.*)$ ]]; then
  FLATTEN=1
  line="${BASH_REMATCH[2]}"
fi
if [[ "$line" =~ (.*)[[:space:]](-f|--flatten)[[:space:]]*$ ]]; then
  FLATTEN=1
  line="${BASH_REMATCH[1]}"
fi

file_display="$line"; page=""
# If the user appended a page suffix (when using Tab to paste), strip & parse it
if [[ "$line" =~ (.*)[[:space:]]-P[[:space:]]*([0-9-]+)$ ]]; then
  file_display="${BASH_REMATCH[1]}"; page="${BASH_REMATCH[2]}"
elif [[ "$line" =~ (.*)[:#]([0-9-]+)$ ]]; then
  file_display="${BASH_REMATCH[1]}"; page="${BASH_REMATCH[2]}"
fi
# rtrim trailing spaces from file_display
file_display="${file_display%"${file_display##*[![:space:]]}"}"

# Map display -> absolute path
abs_path=$(printf '%s\n' "${lines[@]}" | awk -v sel="$file_display" -F '\t' '($1==sel){print $2; exit}') || true
[[ -n "$abs_path" ]] || exit 1

# If requested, flatten the PDF using ghostscript before opening
if (( FLATTEN )); then
  if ! command -v gs >/dev/null 2>&1; then
    echo "❌ ghostscript (gs) not found. Install it to use --flatten." >&2
    exit 1
  fi
  if command -v notify-send >/dev/null 2>&1; then
    notify-send "Flattening PDF" "$abs_path"
  else
    echo "Flattening: $abs_path"
  fi
  tmpfile=$(mktemp --suffix=.pdf)
  if gs -dSAFER -dBATCH -dNOPAUSE -sDEVICE=pdfwrite -dPDFSETTINGS=/ebook -sOutputFile="$tmpfile" "$abs_path"; then
    if mv -f "$tmpfile" "$abs_path"; then
      if command -v notify-send >/dev/null 2>&1; then
        notify-send "Flattening complete" "$abs_path"
      else
        echo "Flattening complete: $abs_path"
      fi
    else
      rm -f "$tmpfile"
      echo "❌ Failed to replace original PDF after flattening." >&2
      exit 1
    fi
  else
    rm -f "$tmpfile"
    echo "❌ Flattening failed for $abs_path" >&2
    exit 1
  fi
fi

# Choose viewer and launch (jump to page if provided)
if (( USE_OKULAR )); then
  if ! command -v "$OKULAR_CMD" >/dev/null 2>&1; then
    echo "❌ okular not found. Install it or set OKULAR_CMD to your okular binary." >&2
    exit 1
  fi
  if [[ -n "$page" ]]; then
    exec "$OKULAR_CMD" --page "$page" "$abs_path"
  else
    exec "$OKULAR_CMD" "$abs_path"
  fi
else
  if ! command -v "$ZATHURA_CMD" >/dev/null 2>&1; then
    echo "❌ zathura not found. Install it or set ZATHURA_CMD to your viewer binary." >&2
    exit 1
  fi
  cmd=("$ZATHURA_CMD" --mode fullscreen)
  if [[ -n "$page" ]]; then
    cmd+=(-P "$page")
  elif (( ZATHURA_SECOND_PAGE )); then
    cmd+=(-P "2")
  fi
  cmd+=("$abs_path")
  exec "${cmd[@]}"
fi
